<!-- crypto.component.html (PRO / PFE / VISUAL + LIVE) -->

<div class="min-h-screen p-4 md:p-8">
  <div class="max-w-7xl mx-auto space-y-6">

    <!-- HERO HEADER -->
    <div class="glass-card rounded-3xl p-6 md:p-10 relative overflow-hidden">
      <!-- deco -->
      <div class="pointer-events-none absolute -top-24 -right-24 h-80 w-80 rounded-full blur-3xl opacity-30 bg-gradient-to-br from-violet-500 to-fuchsia-500"></div>
      <div class="pointer-events-none absolute -bottom-24 -left-24 h-80 w-80 rounded-full blur-3xl opacity-25 bg-gradient-to-br from-emerald-500 to-cyan-500"></div>

      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6 relative z-10">
        <div class="space-y-2">
          <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/70 border border-white/40">
            <span class="inline-flex h-2 w-2 rounded-full"
                  [ngClass]="isLoadingMarketData ? 'bg-amber-500 animate-pulse' : 'bg-emerald-500 animate-pulse'"></span>
            <span class="text-xs font-semibold text-neutral-700">
              {{ isLoadingMarketData ? 'Synchronisation...' : 'Live Market' }}
            </span>
            <span class="text-xs text-neutral-500">•</span>
            <span class="text-xs text-neutral-500">{{ getLastUpdatedString() }}</span>
          </div>

          <h1 class="text-3xl md:text-5xl font-extrabold tracking-tight text-neutral-900">
            Crypto Portfolio <span class="text-neutral-500 font-semibold">Dashboard</span>
          </h1>
          <p class="text-neutral-600 text-sm md:text-base max-w-2xl">
            Données temps réel via CoinGecko • KPIs dynamiques • Graphs Chart.js (Angular) • UX PFE pro
          </p>
        </div>

        <div class="flex flex-col sm:flex-row gap-3 items-stretch sm:items-center">
          <button (click)="refreshMarketData()"
                  class="px-5 py-3 rounded-2xl text-sm font-bold text-white bg-neutral-900 hover:bg-neutral-800 transition disabled:opacity-60 disabled:cursor-not-allowed"
                  [disabled]="isLoadingMarketData">
            Actualiser
          </button>

          <div class="glass-soft rounded-2xl px-4 py-3 flex items-center gap-3">
            <div class="text-xs text-neutral-500 leading-tight">
              <div class="font-semibold text-neutral-700">Sélection</div>
              <div class="font-mono">{{ selectedCrypto }}</div>
            </div>
            <div class="h-10 w-px bg-neutral-200"></div>
            <div class="text-right">
              <div class="text-xs text-neutral-500">Prix</div>
              <div class="font-bold text-neutral-900">{{ formatCurrency(currentPrice) }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- KPI GRID (PRO) -->
    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">

      <!-- Total -->
      <div class="glass-card rounded-3xl p-6 relative overflow-hidden group">
        <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition bg-gradient-to-br from-neutral-900/5 to-transparent"></div>
        <div class="flex items-start justify-between relative z-10">
          <div>
            <p class="text-neutral-500 text-sm font-semibold">Valeur Totale</p>
            <h3 class="text-3xl font-extrabold text-neutral-900 mt-2">
              {{ formatCurrency(portfolioValue) }}
            </h3>
            <p class="text-xs text-neutral-500 mt-2">Portefeuille calculé depuis holdings × prix live</p>
          </div>
          <div class="h-12 w-12 rounded-2xl flex items-center justify-center bg-neutral-900 text-white shadow">
            $
          </div>
        </div>
      </div>

      <!-- Avg 24h -->
      <div class="glass-card rounded-3xl p-6 relative overflow-hidden group">
        <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition bg-gradient-to-br from-emerald-500/10 to-transparent"></div>
        <div class="flex items-start justify-between relative z-10">
          <div>
            <p class="text-neutral-500 text-sm font-semibold">Variation 24h</p>
            <h3 class="text-3xl font-extrabold mt-2"
                [ngClass]="getAverageChange24h() >= 0 ? 'text-emerald-700' : 'text-rose-700'">
              {{ formatPercent(getAverageChange24h()) }}
            </h3>
            <div class="mt-3 flex items-center gap-2 text-xs">
              <span class="px-2 py-1 rounded-full font-semibold"
                    [ngClass]="getAverageChange24h() >= 0 ? 'bg-emerald-50 text-emerald-700' : 'bg-rose-50 text-rose-700'">
                {{ getAverageChange24h() >= 0 ? '↗ Bullish' : '↘ Bearish' }}
              </span>
              <span class="text-neutral-500">moyenne sur coins surveillés</span>
            </div>
          </div>
          <div class="h-12 w-12 rounded-2xl flex items-center justify-center bg-gradient-to-br from-emerald-500 to-cyan-500 text-white shadow">
            %
          </div>
        </div>
      </div>

      <!-- Assets -->
      <div class="glass-card rounded-3xl p-6 relative overflow-hidden group">
        <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition bg-gradient-to-br from-violet-500/10 to-transparent"></div>
        <div class="flex items-start justify-between relative z-10">
          <div>
            <p class="text-neutral-500 text-sm font-semibold">Actifs Live</p>
            <h3 class="text-3xl font-extrabold text-neutral-900 mt-2">{{ marketData.length }}</h3>
            <p class="text-xs text-neutral-500 mt-2">CoinGecko / coins markets</p>
          </div>
          <div class="h-12 w-12 rounded-2xl flex items-center justify-center bg-gradient-to-br from-violet-500 to-fuchsia-500 text-white shadow">
            ∑
          </div>
        </div>
      </div>

      <!-- Best performer -->
      <div class="glass-card rounded-3xl p-6 relative overflow-hidden group">
        <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition bg-gradient-to-br from-amber-500/10 to-transparent"></div>
        <div class="flex items-start justify-between relative z-10">
          <div>
            <p class="text-neutral-500 text-sm font-semibold">Meilleur (24h)</p>
            <h3 class="text-2xl font-extrabold text-neutral-900 mt-2">
              {{ getBestPerformerSymbol() }}
            </h3>
            <div class="mt-3">
              <span class="px-2.5 py-1 rounded-full text-xs font-bold"
                    [ngClass]="getBestPerformerChange() >= 0 ? 'bg-emerald-50 text-emerald-700' : 'bg-rose-50 text-rose-700'">
                {{ formatPercent(getBestPerformerChange()) }}
              </span>
            </div>
          </div>
          <div class="h-12 w-12 rounded-2xl flex items-center justify-center bg-gradient-to-br from-amber-400 to-orange-500 text-white shadow">
            ★
          </div>
        </div>
      </div>
    </section>

    <!-- VISUAL ROW: CHART + WATCHLIST -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- MAIN CHART -->
      <div class="lg:col-span-2 glass-card rounded-3xl p-6 md:p-8">
        <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4 mb-4">
          <div>
            <h2 class="text-xl md:text-2xl font-extrabold text-neutral-900">Top 6 — Prix (USD)</h2>
            <p class="text-neutral-500 text-sm">Graph dynamique mis à jour à chaque tick (30s)</p>
          </div>

          <div class="flex items-center gap-2">
            <select class="px-4 py-2 rounded-2xl border border-neutral-200 bg-white/80 text-sm font-semibold"
                    [(ngModel)]="selectedCrypto"
                    (change)="onCryptoChange()">
              <option *ngFor="let c of marketData" [value]="c.symbol">
                {{ c.symbol }} — {{ c.name }}
              </option>
            </select>
          </div>
        </div>

        <div class="chart-shell">
          <canvas #portfolioChart></canvas>
        </div>

        <div class="mt-5 grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="glass-soft rounded-2xl p-4 border border-white/30">
            <div class="text-xs text-neutral-500 font-semibold">Prix actuel</div>
            <div class="text-lg font-extrabold text-neutral-900 mt-1">{{ formatCurrency(currentPrice) }}</div>
          </div>
          <div class="glass-soft rounded-2xl p-4 border border-white/30">
            <div class="text-xs text-neutral-500 font-semibold">Quantité (trade)</div>
            <div class="text-lg font-extrabold text-neutral-900 mt-1">
              {{ getCryptoAmountForTrade() | number:'1.0-8' }} {{ selectedCrypto }}
            </div>
          </div>
          <div class="glass-soft rounded-2xl p-4 border border-white/30">
            <div class="text-xs text-neutral-500 font-semibold">Frais (0.25%)</div>
            <div class="text-lg font-extrabold text-neutral-900 mt-1">
              {{ formatCurrency(tradeAmount * 0.0025) }}
            </div>
          </div>
        </div>
      </div>

      <!-- WATCHLIST (mini cards) -->
      <div class="glass-card rounded-3xl p-6 md:p-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-extrabold text-neutral-900">Watchlist</h2>
          <span class="text-xs text-neutral-500">Live</span>
        </div>

        <div class="space-y-3">
          <button *ngFor="let c of marketData"
                  (click)="selectedCrypto = c.symbol; onCryptoChange()"
                  class="w-full text-left rounded-2xl p-4 border border-neutral-200 hover:border-neutral-300 hover:shadow-md transition bg-white/70">
            <div class="flex items-center justify-between gap-3">
              <div class="min-w-0">
                <div class="flex items-center gap-2">
                  <span class="text-sm font-extrabold text-neutral-900">{{ c.symbol }}</span>
                  <span class="text-xs text-neutral-500 truncate">{{ c.name }}</span>
                </div>
                <div class="text-sm font-bold text-neutral-900 mt-1">{{ formatCurrency(c.price) }}</div>
              </div>

              <div class="text-right">
                <span class="inline-flex px-2.5 py-1 rounded-full text-xs font-bold"
                      [ngClass]="c.changePercent >= 0 ? 'bg-emerald-50 text-emerald-700' : 'bg-rose-50 text-rose-700'">
                  {{ formatPercent(c.changePercent) }}
                </span>
                <div class="text-[11px] text-neutral-500 mt-2">
                  Vol {{ c.volume | number:'1.0-0' }}
                </div>
              </div>
            </div>
          </button>
        </div>

      </div>
    </div>

    <!-- HOLDINGS TABLE (PRO) -->
    <div class="glass-card rounded-3xl p-6 md:p-8">
      <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4 mb-4">
        <div>
          <h2 class="text-xl md:text-2xl font-extrabold text-neutral-900">Marché (Live)</h2>
          <p class="text-neutral-500 text-sm">Tri visuel par performance, données CoinGecko</p>
        </div>

        <div class="flex gap-2">
          <button class="px-4 py-2 rounded-2xl text-sm font-bold border border-neutral-200 bg-white/70 hover:bg-white transition"
                  (click)="sortMarketBy('cap')">
            Trier: Market Cap
          </button>
          <button class="px-4 py-2 rounded-2xl text-sm font-bold border border-neutral-200 bg-white/70 hover:bg-white transition"
                  (click)="sortMarketBy('chg')">
            Trier: 24h
          </button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b border-neutral-200">
              <th class="text-left py-3 px-4 text-xs font-extrabold text-neutral-500 uppercase tracking-wider">Actif</th>
              <th class="text-right py-3 px-4 text-xs font-extrabold text-neutral-500 uppercase tracking-wider">Prix</th>
              <th class="text-right py-3 px-4 text-xs font-extrabold text-neutral-500 uppercase tracking-wider">24h</th>
              <th class="text-right py-3 px-4 text-xs font-extrabold text-neutral-500 uppercase tracking-wider">Volume</th>
              <th class="text-right py-3 px-4 text-xs font-extrabold text-neutral-500 uppercase tracking-wider">Market Cap</th>
              <th class="text-right py-3 px-4 text-xs font-extrabold text-neutral-500 uppercase tracking-wider">Action</th>
            </tr>
          </thead>

          <tbody class="divide-y divide-neutral-100">
            <tr *ngFor="let c of marketData" class="hover:bg-white/60 transition">
              <td class="py-4 px-4">
                <div class="flex items-center gap-3">
                  <img *ngIf="c.image" [src]="c.image" [alt]="c.symbol" class="h-9 w-9 rounded-2xl border border-neutral-200 bg-white" />
                  <div class="min-w-0">
                    <div class="font-extrabold text-neutral-900 truncate">
                      {{ c.name }}
                      <span class="text-xs font-semibold text-neutral-500">({{ c.symbol }})</span>
                    </div>
                    <div class="text-xs text-neutral-500 font-mono">
                      H {{ formatCurrency(c.high24h) }} • L {{ formatCurrency(c.low24h) }}
                    </div>
                  </div>
                </div>
              </td>

              <td class="py-4 px-4 text-right font-mono text-sm font-bold text-neutral-900">
                {{ formatCurrency(c.price) }}
              </td>

              <td class="py-4 px-4 text-right">
                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-extrabold"
                      [ngClass]="c.changePercent >= 0 ? 'bg-emerald-50 text-emerald-700' : 'bg-rose-50 text-rose-700'">
                  {{ c.changePercent >= 0 ? '↑' : '↓' }} {{ formatPercent(c.changePercent).replace('+','') }}
                </span>
              </td>

              <td class="py-4 px-4 text-right font-mono text-xs text-neutral-700">
                {{ c.volume | number:'1.0-0' }}
              </td>

              <td class="py-4 px-4 text-right font-mono text-xs text-neutral-700">
                {{ c.marketCap | number:'1.0-0' }}
              </td>

              <td class="py-4 px-4 text-right">
                <button class="px-3 py-2 rounded-2xl text-xs font-extrabold bg-neutral-900 text-white hover:bg-neutral-800 transition"
                        (click)="selectedCrypto = c.symbol; onCryptoChange()">
                  Voir
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>
